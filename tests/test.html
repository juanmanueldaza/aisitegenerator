<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Site Generator - Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
            line-height: 1.6;
        }
        .test-result {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>AI Site Generator - Test Suite</h1>
    <div id="test-results"></div>

    <!-- Load the application modules -->
    <script src="../src/js/markdown-renderer.js"></script>
    <script src="../src/js/mermaid-integration.js"></script>

    <script>
        class TestSuite {
            constructor() {
                this.results = [];
                this.testsRun = 0;
                this.testsPassed = 0;
            }

            async runAllTests() {
                console.log('Starting test suite...');
                
                // Test markdown rendering
                await this.testMarkdownBasics();
                await this.testMarkdownHeaders();
                await this.testMarkdownFormatting();
                await this.testCodeBlocks();
                
                // Test Mermaid integration
                await this.testMermaidIntegration();
                await this.testMermaidErrorHandling();
                
                // Test performance
                await this.testPerformance();
                
                this.displayResults();
            }

            async testMarkdownBasics() {
                this.log('Testing basic markdown rendering...');
                const renderer = new MarkdownRenderer();
                
                const testCases = [
                    {
                        input: '# Hello World',
                        expected: '<h1>Hello World</h1>',
                        description: 'H1 header'
                    },
                    {
                        input: '**bold** and *italic*',
                        expected: '<p><strong>bold</strong> and <em>italic</em></p>',
                        description: 'Bold and italic formatting'
                    },
                    {
                        input: '`code`',
                        expected: '<p><code>code</code></p>',
                        description: 'Inline code'
                    }
                ];

                for (const testCase of testCases) {
                    const result = await renderer.render(testCase.input);
                    this.assert(
                        result.includes(testCase.expected.replace('<p>', '').replace('</p>', '')),
                        `${testCase.description}: Expected output to contain formatted elements`
                    );
                }
            }

            async testMarkdownHeaders() {
                this.log('Testing markdown headers...');
                const renderer = new MarkdownRenderer();
                
                const testCases = [
                    { input: '# H1', tag: 'h1' },
                    { input: '## H2', tag: 'h2' },
                    { input: '### H3', tag: 'h3' }
                ];

                for (const testCase of testCases) {
                    const result = await renderer.render(testCase.input);
                    this.assert(
                        result.includes(`<${testCase.tag}>`),
                        `Header ${testCase.tag} should be rendered correctly`
                    );
                }
            }

            async testMarkdownFormatting() {
                this.log('Testing markdown formatting...');
                const renderer = new MarkdownRenderer();
                
                const boldTest = await renderer.render('**bold text**');
                this.assert(
                    boldTest.includes('<strong>bold text</strong>'),
                    'Bold text should be wrapped in <strong> tags'
                );

                const italicTest = await renderer.render('*italic text*');
                this.assert(
                    italicTest.includes('<em>italic text</em>'),
                    'Italic text should be wrapped in <em> tags'
                );
            }

            async testCodeBlocks() {
                this.log('Testing code block rendering...');
                const renderer = new MarkdownRenderer();
                
                const codeBlock = '```javascript\nconsole.log("hello");\n```';
                const result = await renderer.render(codeBlock);
                
                this.assert(
                    result.includes('<pre><code'),
                    'Code blocks should be wrapped in <pre><code> tags'
                );
                
                this.assert(
                    result.includes('console.log'),
                    'Code content should be preserved'
                );
            }

            async testMermaidIntegration() {
                this.log('Testing Mermaid integration...');
                const mermaidIntegration = new MermaidIntegration();
                
                // Test initialization
                this.assert(
                    typeof mermaidIntegration.initialize === 'function',
                    'MermaidIntegration should have initialize method'
                );
                
                // Test error handling when Mermaid is not available
                const renderer = new MarkdownRenderer();
                renderer.setMermaidIntegration(mermaidIntegration);
                
                const mermaidCode = '```mermaid\ngraph TD\n    A --> B\n```';
                const result = await renderer.render(mermaidCode);
                
                // Should handle gracefully when Mermaid can't load
                this.assert(
                    result.includes('mermaid-error') || result.includes('mermaid-container'),
                    'Should handle Mermaid blocks (either render or show error)'
                );
            }

            async testMermaidErrorHandling() {
                this.log('Testing Mermaid error handling...');
                const mermaidIntegration = new MermaidIntegration();
                
                // Test validation
                const validation = mermaidIntegration.validateDiagramSyntax('');
                this.assert(
                    !validation.isValid,
                    'Empty diagram should be invalid'
                );
                
                const validValidation = mermaidIntegration.validateDiagramSyntax('graph TD\n    A --> B');
                this.assert(
                    validValidation.isValid,
                    'Valid diagram syntax should pass validation'
                );
            }

            async testPerformance() {
                this.log('Testing performance...');
                const renderer = new MarkdownRenderer();
                
                const largeContent = '# Header\n' + 'This is a paragraph. '.repeat(100);
                
                const startTime = performance.now();
                await renderer.render(largeContent);
                const endTime = performance.now();
                
                const renderTime = endTime - startTime;
                this.assert(
                    renderTime < 1000, // Should render in less than 1 second
                    `Large content should render quickly (took ${renderTime.toFixed(2)}ms)`
                );
            }

            assert(condition, message) {
                this.testsRun++;
                if (condition) {
                    this.testsPassed++;
                    this.results.push({ type: 'pass', message });
                } else {
                    this.results.push({ type: 'fail', message });
                }
            }

            log(message) {
                this.results.push({ type: 'info', message });
                console.log(message);
            }

            displayResults() {
                const container = document.getElementById('test-results');
                
                // Summary
                const summary = document.createElement('div');
                summary.className = this.testsPassed === this.testsRun ? 'test-result test-pass' : 'test-result test-fail';
                summary.innerHTML = `
                    <h2>Test Summary</h2>
                    <p><strong>${this.testsPassed}/${this.testsRun}</strong> tests passed</p>
                    <p>Success rate: ${((this.testsPassed / this.testsRun) * 100).toFixed(1)}%</p>
                `;
                container.appendChild(summary);

                // Individual results
                this.results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = `test-result test-${result.type}`;
                    div.textContent = result.message;
                    container.appendChild(div);
                });

                console.log(`Test suite completed: ${this.testsPassed}/${this.testsRun} tests passed`);
            }
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            const testSuite = new TestSuite();
            await testSuite.runAllTests();
        });
    </script>
</body>
</html>